<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/x-icon" href="favicon_carousel.ico">
    <title>Rotation Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        table,
        th,
        td {
            border: 1px solid black;
        }

        td {
            text-align: center;
        }

        body {
            font-family: Verdana, Geneva, Arial, sans-serif;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <script src="gauge.min.js"></script>
    <script src="beep.js"></script>
    <div style="text-align: center;"><canvas id="canvas-preview" width="380" height="230"></canvas></div>
    <table style="width:100%">
        <tr>
            <td style="width: 50%">rotations</td>
            <td style="width: 50%"><span id="rotations"></span></td>
        </tr>
        <tr>
            <td style="width: 50%">compass rotations</td>
            <td style="width: 50%"><span id="compass_rotations"></span></td>
        </tr>
        <tr>
            <td>trips</td>
            <td><span id="trips"></span></td>
        </tr>
        <tr>
            <td>trip duration</td>
            <td id="duration_cell"><span id="duration"></span></td>
        </tr>
        <tr>
            <td>min. duration (s)</td>
            <td style="text-align: left;">
                <input type="radio" id="minDurationA" name="minDurationRadio" checked onchange="toggleMinDuration();">
                <input type="number" id="minDurationInputA" value="160" min="10" max="180" step="10" onchange="toggleMinDuration();" pattern="\d*"><br>
                <input type="radio" id="minDurationB" name="minDurationRadio"onchange="toggleMinDuration();">
                <input type="number" id="minDurationInputB" value="130" min="10" max="180" step="10" onchange="toggleMinDuration();" pattern="\d*">
            </td>
        </tr>
        <tr>
            <td>sound</td>
            <td style="text-align: left;">
                <input type="radio" id="soundOff" name="soundEnabled" checked onchange="toggleSound()">
                <label for="soundOff">off</label><br>
                <input type="radio" id="soundShort" name="soundEnabled" onchange="toggleSound()">
                <label for="soundShort">short</label><br>
                <input type="radio" id="soundLong" name="soundEnabled" onchange="toggleSound()">
                <label for="soundLong">long</label><br>
            </td>
        </tr>
    </table>
    <script>
        function toggleMinDuration() {
            if (minDurationA.checked) {
                minTripDuration = parseFloat(minDurationInputA.value);
            } else {
                minTripDuration = parseFloat(minDurationInputB.value);
            }
        }
        function toggleSound() {
            if (!soundOff.checked) {
                console.log('enable sound');
                myAudioContext.resume();
            } else {
                console.log('disable sound');
                myAudioContext.suspend();
            }
        }
        const toneFrequencies = {
            'g1': 391.995,
            'a1': 440,
            'h1': 493.883,
            'c2': 523.251,
            'd2': 587.330,
            'e2': 659.255,
            'f2': 698.456,
            'g2': 783.991,
            'a2': 880
        };
        function playNote(note, divisor, delay, volume, bpm, dutyCycle) {
            delay = delay || 0;
            volume = volume || 100;
            bpm = bpm || 150;
            dutyCycle = dutyCycle || 0.6;
            timeInterval = 24e4 / bpm / divisor;
            if (note != 'p')
                setTimeout(beep, delay, dutyCycle * timeInterval, toneFrequencies[note], volume);
            return delay + timeInterval;
        }
        const opts = {
            angle: 0.15, /// The span of the gauge arc
            lineWidth: 0.44, // The line thickness
            pointer: {
                length: 0.63, // Relative to gauge radius
                strokeWidth: 0.035 // The thickness
            },
            limitMax: true,
            limitMin: true,
            strokeColor: '#E0E0E0',
            staticLabels: {
                font: "14px sans-serif", // Specifies font
                labels: [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], // Print labels at these values
                color: "#000000", // Optional: Label text color
                fractionDigits: 0 // Optional: Numerical precision. 0=round off.
            },
            renderTicks: {
                divisions: 11,
                divWidth: 1.6,
                divLength: 0.5,
                divColor: '#333333',
                subDivisions: 4,
                subLength: 0.3,
                subWidth: 0.4,
                subColor: '#666666'
            },
            staticZones: [{
                    strokeStyle: "#F03E3E",
                    min: -1,
                    max: 0
                }, // Red
                {
                    strokeStyle: "#FFDD00",
                    min: 0,
                    max: 2.5
                }, // Yellow
                {
                    strokeStyle: "#30B32D",
                    min: 2.5,
                    max: 5.5
                }, // Green
                {
                    strokeStyle: "#FFDD00",
                    min: 5.5,
                    max: 7.5
                }, // Yellow
                {
                    strokeStyle: "#F03E3E",
                    min: 7.5,
                    max: 10
                } // Red
            ]
        };
        const target = document.getElementById('canvas-preview');
        const gauge = new Gauge(target).setOptions(opts);
        const volume = 100;
        var minTripDuration = 16;
        gauge.maxValue = 10; // set max gauge value
        gauge.setMinValue(-1); // set min value
        var ws = undefined;
        var beeped = false;

        function connect() {
            ws_rotation = new WebSocket("ws://" + window.location.host + "/ws/rotation");
            ws_rotation.onmessage = function(event) {
                let message = JSON.parse(event.data);
                var delay = 0;
                gauge.set(message.rpm);
                rotations.innerHTML = message.rotations;
                compass_rotations.innerHTML = message.compass_rotations;
                trips.innerHTML = message.trips;
                if (message.on_trip) {
                    if (message.trip_duration >= minTripDuration) {
                        duration_cell.style.background = 'lightgreen';
                        if (!beeped && !soundOff.checked) {
                            beeped = true;
                            delay = playNote('c2', 4, delay);
                            delay = playNote('d2', 4, delay);
                            delay = playNote('e2', 4, delay);
                            delay = playNote('c2', 4, delay);

                            delay = playNote('c2', 4, delay);
                            delay = playNote('d2', 4, delay);
                            delay = playNote('e2', 4, delay);
                            delay = playNote('c2', 4, delay);

                            delay = playNote('e2', 4, delay);
                            delay = playNote('f2', 4, delay);
                            delay = playNote('g2', 2, delay);

                            delay = playNote('e2', 4, delay);
                            delay = playNote('f2', 4, delay);
                            delay = playNote('g2', 2, delay);

                            if (soundLong.checked) {
                                delay = playNote('g2', 8 / 1.5, delay);
                                delay = playNote('a2', 16, delay);
                                delay = playNote('g2', 8, delay);
                                delay = playNote('f2', 8, delay);
                                delay = playNote('e2', 4, delay);
                                delay = playNote('c2', 4, delay);

                                delay = playNote('g2', 8 / 1.5, delay);
                                delay = playNote('a2', 16, delay);
                                delay = playNote('g2', 8, delay);
                                delay = playNote('f2', 8, delay);
                                delay = playNote('e2', 4, delay);
                                delay = playNote('c2', 4, delay);
                                
                                delay = playNote('c2', 4, delay);
                                delay = playNote('g1', 4, delay);
                                delay = playNote('c2', 2, delay);

                                delay = playNote('c2', 4, delay);
                                delay = playNote('g1', 4, delay);
                                delay = playNote('c2', 2, delay);
                            }
                        }
                    } else {
                        duration_cell.style.background = 'lightyellow';
                    }
                    duration.innerHTML = message.trip_duration + "&nbsp;s";
                } else {
                    duration.innerHTML = "";
                    duration_cell.style.background = '';
                    beeped = false;
                }
            }
            ws_rotation.onclose = function(e) {
                console.log('Socket is closed. Reconnect will be attempted in 5 seconds.', e.reason);
                setTimeout(function() {
                    connect();
                }, 5000);
            }
        }
        connect();
    </script>
</body>

</html>
